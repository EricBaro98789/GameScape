<!DOCTYPE html>
<html lang="en">

<head>
    <title>Admin Panel</title>
    <link rel="stylesheet" href="assets/css/admin-style.css">
</head>

<body>
    <h1>Admin User Management</h1>
    <table id="user-table"></table>

    <h2>Add New User</h2>
    <form id="addUserForm">
        <input type="text" id="newUsername" placeholder="Username" required />
        <input type="email" id="newEmail" placeholder="Email" required />
        <input type="password" id="newPassword" placeholder="Password" required />
        <select id="newRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
        </select>
        <button type="submit">Add User</button>
    </form>

    <h2>Update User Info</h2>
    <form id="editUserForm" enctype="multipart/form-data">
        <input type="number" id="editUserId" placeholder="User ID" required />
        <input type="text" name="address" placeholder="New Address" />
        <input type="file" name="avatar" />
        <button type="submit">Update User</button>
    </form>

    <script>
        fetch('/admin/users', {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        })
            .then(res => res.json())
            .then(users => {
                const table = document.getElementById('user-table');
                table.innerHTML = `
        <tr><th>ID</th><th>Username</th><th>Email</th><th>Role</th><th>Actions</th></tr>
        ${users.map(u => `
          <tr>
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td>${u.username}</td>
            <td><img src="${u.avatar_url || '/default-avatar.png'}" class="avatar-img"></td>
            <td>${u.address || 'Not provided'}</td>
            <td>
              <button class="edit-btn" onclick="openEditModal(${u.id})">Edit Profile</button>
              <button class="delete-btn" onclick="deleteUser(${u.id})">Delete</button>
              <button class="role-btn" onclick="changeRole(${u.id}, ${!u.isAdmin})">${u.isAdmin ? "Demote" : "Promote"}</button>
            </td>
          </tr>`).join('')}
      `;
            });

        function deleteUser(id) {
            fetch(`/admin/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            }).then(() => location.reload());
        }

        function changeRole(id, newRole) {
            fetch(`/admin/users/${id}/role`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify({ role: newRole })
            }).then(() => location.reload());
        }

        function openEditModal(userId) {
            document.getElementById("editModal").style.display = "block";
            document.getElementById("editUserId").value = userId;

            // Optional: Load address if needed
            fetch(`/admin/users/${userId}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("editAddress").value = data.address || "";
                });
        }

        function closeEditModal() {
            document.getElementById("editModal").style.display = "none";
        }

        document.getElementById("editForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const userId = formData.get("user_id");

            fetch(`/admin/users/${userId}/update`, {
                method: "PUT",
                body: formData
            }).then(res => {
                if (res.ok) {
                    alert("Profile updated successfully!");
                    location.reload();
                } else {
                    alert("Failed to update profile.");
                }
            });
        });

        document.getElementById("addUserForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const response = await fetch("/admin/users/add", {
                method: "POST",
                headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                body: JSON.stringify({
                    username: document.getElementById("newUsername").value,
                    email: document.getElementById("newEmail").value,
                    password: document.getElementById("newPassword").value,
                    role: document.getElementById("newRole").value,
                }),
            });

            if (response.ok) {
                alert("User added successfully");
                location.reload();
            } else {
                const err = await response.json();
                alert("Failed to add user: " + err.message);
            }
        });

        document.getElementById("editUserForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const token = localStorage.getItem("token");
            const formData = new FormData(this);
            const userId = document.getElementById("editUserId").value;

            const res = await fetch(`/admin/users/${userId}/update`, {
                method: "PUT",
                headers: { Authorization: "Bearer " + token },
                body: formData
            });

            if (res.ok) {
                alert("User updated successfully");
                location.reload();
            } else {
                const err = await res.json();
                alert("Update failed: " + err.message);
            }
        });

    </script>
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Edit User Profile</h3>
            <form id="editForm" enctype="multipart/form-data">
                <input type="hidden" name="user_id" id="editUserId">

                <label for="editAddress">Address:</label><br>
                <input type="text" name="address" id="editAddress" placeholder="Enter address"><br><br>

                <label for="editAvatar">Avatar:</label><br>
                <input type="file" name="avatar" id="editAvatar"><br><br>

                <button type="submit" class="modal-save-btn">Save Changes</button>
            </form>
        </div>
    </div>
</body>

</html>